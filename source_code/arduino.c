#include <AD9833.h>       // Include the AD9833 library, which allows control of the AD9833 waveform generator
#include <avr/pgmspace.h> // Include a library for storing data in program space (flash memory) rather than RAM

#define AD9833_FSYNC 10 // Define the pin (pin 10) used for FSYNC (chip select) to communicate with the AD9833 module

AD9833 ad9833(AD9833_FSYNC); // Create an instance of the AD9833 class, passing the FSYNC pin as a parameter

// An array stored in flash memory (PROGMEM) that holds randomized values for frequency adjustments
const uint8_t randomized[] PROGMEM = {
    130, 1329, 633, 572, 98, 230, 396, 1719, 1265, 1369, 1654, 1527, 383, 1688, 334, 602, 1892, 658, 1832, 1703,
    1152, 541, 275, 1671, 646, 1, 1335, 403, 922, 162, 401, 613, 1586, 741, 489, 821, 930, 1549, 683, 259, 1694,
    38, 944, 1563, 504, 1311, 299, 43, 758, 114, 168, 1930, 1706, 1028, 1377, 282, 695, 560, 1382, 1876, 1073,
    1651, 1128, 42, 64, 1086, 371, 714, 1175, 1212, 1999, 583, 117, 615, 1566, 822, 1328, 1530, 1316, 805, 1575,
    137, 1062, 761, 470, 119, 420, 618, 1721, 949, 1097, 47, 554, 1036, 1846, 800, 1418, 869, 878, 1590, 1589,
    117, 612, 1563, 86, 795, 655, 1029, 1965, 1868, 608, 1147, 1099, 604, 683, 1115, 748, 1669, 1401, 1905, 1127,
    491, 1851, 1536, 685, 1332, 1761, 1723, 1047, 811, 1327, 734, 1339, 1362, 1582, 283, 1486, 499, 1398, 1206,
    1470, 1547, 874, 31, 1700, 1685, 239, 860, 1258, 949, 1044, 448, 437, 1003, 1509, 949, 1543, 33, 969, 946,
    939, 1860, 156, 183, 384, 625, 1344, 1425, 862, 1599, 1166, 988, 482, 1475, 2, 1716, 78, 1765, 508, 1985,
    1292, 265, 98, 814, 1945, 1464, 215, 1164, 1607, 657, 1943, 1431, 1480, 1126, 689, 100, 1908, 1525, 399, 863,
    504, 1985, 463, 612, 1175, 1279, 481, 1402, 1039, 289, 962, 1562, 1079, 1621, 60, 1981, 1946, 1538, 1692,
    1165, 1574, 281, 278, 1859, 1428, 21, 825, 998, 1332, 1099, 375, 1560, 269, 1575, 279, 1396, 1426, 1264, 1074,
    811, 1799, 1232, 233, 1842, 1634, 809, 1349, 1769, 565, 61, 252, 1529, 1766, 1728, 1141, 880, 356, 567, 688,
    437, 61, 1933, 1592, 245, 1421, 1832, 1469, 3, 1389, 1188, 226, 1008, 264, 865, 937, 1520, 499, 805, 1044,
    298, 1467, 1734, 754, 708, 874, 1493, 174, 668, 18, 113, 186, 1999, 1566, 529, 1764, 464, 1970, 1246, 630,
    241, 980, 956, 1434, 599, 940, 1782, 1399, 1244, 152, 1767, 385, 1519, 1176, 242, 315, 285, 633, 764, 1911,
    875, 891, 210, 1281, 40, 868, 287, 1132, 1558, 985, 65, 1428, 1213, 114, 1114, 904, 1658, 1682, 673, 1660,
    1727, 1605, 989, 1574, 1093, 280, 1622, 374, 101, 1458, 71, 1204, 1948, 1781, 1784, 360, 537, 1510, 297, 547,
    45, 998, 472, 1091, 1305, 760, 1686, 768, 1801, 1325, 690, 746, 445, 1325, 701, 578, 403, 1985, 925, 1930,
    279, 360, 1668, 482, 442, 1598, 1459, 524, 517, 1096, 1268, 257, 1509, 1086, 611, 1325, 1542, 1956, 1678,
    1170, 216, 433, 983, 92, 150, 474, 883, 1208, 1158, 697, 1946, 588, 1973, 1409, 76, 50, 813, 1989, 1739, 209,
    664, 1320, 2000, 23, 837, 1680, 1471, 1623, 556, 1323, 790, 1880, 1876, 374, 1022, 313, 743, 1011, 1561, 934,
    1578, 159, 247, 581, 901, 252, 144, 1059, 1871, 877, 572, 271, 1494, 446, 254, 1374, 181, 1928, 110, 524,
    1068, 218, 1252, 1275, 1865, 457, 471, 1052, 1081, 1690, 1099, 184, 1759, 483, 1495, 1797, 94, 1719, 521,
    870, 1039, 1620, 1476, 282, 819, 10, 1104, 1876, 1703, 314, 1197, 1758, 702, 939, 1170, 1377, 1788, 1784,
    895, 644, 77};

void setup()
{
    Serial.begin(9600);
    Serial.println("AD9833 Sweep Test");

    ad9833.begin();                 // Initialize communication with the AD9833 module
    ad9833.setWave(AD9833_SQUARE1); // Set the waveform type to SQUARE1 (square wave) for the AD9833 signal generator
    ad9833.setPhase(0);             // Set the phase of the signal to 0 degrees
}

void loop()
{
    // Iterate through the 'randomized' array to adjust the frequency dynamically
    for (uint16_t i = 0; i < sizeof(randomized); i++)
    {
        // Read the value stored in the 'randomized' array from program memory
        uint8_t rand_val = pgm_read_byte_near(randomized + i);

        // Set the frequency of the AD9833 to 24 kHz plus the random value
        // This creates a randomized sweep effect around the 24 kHz base frequency
        ad9833.setFrequency(24000 + rand_val, 0);

        // Wait for 100 milliseconds before setting the next frequency
        delay(100);
    }
}
